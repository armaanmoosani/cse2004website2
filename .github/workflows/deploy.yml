name: Deploy to GitHub Pages

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare deploy folder
        run: |
          rm -rf public
          mkdir public
          cp -r index.html search.js style.css public/
      
      - name: Replace placeholders (safe Node replacement)
        env:
          API_KEY: ${{ secrets.API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        run: |
          node -e '
            const fs = require("fs");
            const p = "public/search.js";
            let s = fs.readFileSync(p, "utf8");
            s = s.split("API_KEY_PLACEHOLDER").join(process.env.API_KEY || "");
            s = s.split("GEMINI_API_KEY").join(process.env.GEMINI_API_KEY || "");
            s = s.split("FINNHUB_API_KEY").join(process.env.FINNHUB_API_KEY || "");
            fs.writeFileSync(p, s, "utf8");
            console.log("Replacements applied to public/search.js");
          '

      - name: Fail if any placeholder remains
        run: |
          if grep -q "API_KEY_PLACEHOLDER" public/search.js || grep -q "GEMINI_API_KEY" public/search.js || grep -q "FINNHUB_API_KEY" public/search.js; then
            echo "Placeholder still present in public/search.js. Aborting.";
            exit 1;
          else
            echo "No placeholders found â€” ready to deploy.";
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
